<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Retornos | Dra. Rafaela Loiola</title>

<style>body{display:none!important}</style>

<script>
(function(){
    const PAGE_PASSWORD="rafaloiola2026";
    const entered=prompt("‚ú® Digite a senha para acessar o painel ‚ú®");
    if(entered!==PAGE_PASSWORD){
        alert("Senha incorreta. Acesso n√£o autorizado üå∏");
        document.open();document.write("");document.close();
        return;
    }
    document.addEventListener("DOMContentLoaded", function() {
        const st=document.createElement("style");
        st.innerHTML="body{display:block!important}";
        document.head.appendChild(st);
    });
})();
</script>

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const sb = supabase.createClient(
    "https://kavfloijxglfzlwgvtmd.supabase.co",
    "sb_publishable_Fqmz6y2CXCzBCzGLINr2Pg_L_my3zDP"
);
</script>

<style>
:root{
--bg:#fdfafb;--card:#fff;--primary:#e8b6c2;--accent:#b87486;
--border:#f1d6dd;--text:#4a3a3d;
--agendado:#e6f2ec;--tentar:#f5efe6;--recusou:#f3e1e1;
--wa:#25d366;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);margin:0}
header{background:linear-gradient(135deg,#f3ccd6,#e6b7c3);padding:2.6rem 1rem;text-align:center}
header h1{margin:0;font-size:2.5rem;font-family:'Quicksand'}
header p{margin:10px 0 0;font-size:1.3rem;font-weight:800}

.counters{display:flex;justify-content:center;gap:18px;margin-top:22px;flex-wrap:wrap}
.counter{background:#ffffffaa;padding:12px 20px;border-radius:20px;font-weight:700}

.tabs{display:flex;justify-content:center;gap:14px;margin:1.2rem}
.tab-btn{padding:14px 40px;border-radius:35px;border:1px solid var(--border);background:#fff;font-weight:800;cursor:pointer;font-size:1rem;display:flex;align-items:center;gap:10px}
.tab-btn span{font-size:1.5rem}
.tab-btn.active{background:var(--primary);color:#fff}

.table-card{background:#fff;border-radius:24px;overflow-x:auto;margin:0 1rem;box-shadow: 0 4px 10px rgba(0,0,0,0.03)}
table{width:100%;border-collapse:collapse; min-width: 1000px;}
th{background:#fbf1f4;padding:12px;font-size:.72rem;color:var(--accent); text-transform: uppercase}
td{padding:10px;border-bottom:1px solid var(--border);text-align:center;font-size:.86rem}

.w-seq{width:40px}
.w-paciente{width:18%}
.w-tel{width:180px}

textarea,select{width:96%;border-radius:12px;border:1px solid var(--border);padding:8px;font-family: inherit}

.wa-btn{display:inline-flex;align-items:center;gap:8px;background:#eef8f1;color:#1e8449;text-decoration:none;padding:8px 14px;border-radius:16px;font-weight:700;transition: 0.3s;}
.wa-btn:hover{background:var(--wa);color:#fff}

.status-Agendado{background:var(--agendado)}
.status-Tentar\ Novamente{background:var(--tentar)}
.status-Recusou{background:var(--recusou)}

.import-section{display:flex;gap:16px;justify-content:center;margin:45px auto 25px; flex-wrap: wrap}
.import-box{background:#fff;padding:16px;border-radius:22px;border:2px dashed var(--primary);max-width:360px;flex:1;text-align:center}
.btn-file{background:var(--accent);color:#fff;border:none;padding:12px;border-radius:18px;font-weight:800;cursor:pointer;width:100%}

.log-box{margin:30px auto;background:#fff;padding:28px;border-radius:26px;max-width:650px;text-align:center; border: 1px solid var(--border)}
.btn-save{position:fixed;bottom:26px;right:26px;background:var(--accent);color:#fff;border:none;padding:18px 38px;border-radius:50px;font-weight:800;cursor:pointer;box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 100;}
.footer-spacer{height:150px}
#syncStatus { font-size: 0.9rem; color: #b87486; margin-top: 8px; font-weight: 700; height: 20px; }
</style>
</head>

<body>

<header>
    <h1>üå∏ Controle de Retornos de Pacientes üå∏</h1>
    <p>üë©‚Äç‚öïÔ∏è Dra. Rafaela Loiola ‚ú®</p>
    <div id="syncStatus">Sincronizando...</div>
    <div class="counters">
        <div class="counter">‚è≥ Pendentes: <span id="cPend">0</span></div>
        <div class="counter">‚úÖ Agendados: <span id="cAgen">0</span></div>
        <div class="counter">üîÅ Tentar: <span id="cTent">0</span></div>
        <div class="counter">‚ùå Recusou: <span id="cRec">0</span></div>
    </div>
</header>

<div class="tabs">
    <button class="tab-btn" id="tP" onclick="changeTab('proximo')"><span>üß∏</span> A vencer</button>
    <button class="tab-btn" id="tV" onclick="changeTab('vencidos')"><span>üçÇ</span> Vencidos</button>
</div>

<div class="table-card">
    <table>
        <thead>
            <tr>
                <th class="w-seq">#</th>
                <th class="w-paciente">Paciente</th>
                <th class="w-tel">WhatsApp</th>
                <th>√öltima</th>
                <th>Idade</th>
                <th id="dateLabel">Data</th>
                <th>Status</th>
                <th>Observa√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="import-section">
    <div class="import-box">
        <input type="file" id="fP" hidden onchange="importCSV('proximo',this)">
        <button class="btn-file" onclick="fP.click()">üçº Importar lista A Vencer</button>
    </div>
    <div class="import-box">
        <input type="file" id="fV" hidden onchange="importCSV('vencidos',this)">
        <button class="btn-file" onclick="fV.click()">‚ö†Ô∏è Importar lista Vencida</button>
    </div>
</div>

<div class="log-box">
    <h3>üìú Gerar Relat√≥rio de Atividades</h3>
    <input type="date" id="logIni"> at√© <input type="date" id="logFim">
    <br><br>
    <button class="btn-file" onclick="gerarLog()" style="max-width:200px">üíæ Baixar Log (.txt)</button>
</div>

<div class="footer-spacer"></div>
<button class="btn-save" id="btnSalvar" onclick="saveData()">üíñ Salvar Tudo na Nuvem</button>

<script>
let state = { active: "proximo", proximo: [], vencidos: [] };

function formatAge(val) {
    if (!val) return "";
    let s = val.toString().replace(',', '.');
    let n = parseFloat(s);
    if (isNaN(n)) return val;
    let anos = Math.floor(n);
    let meses = Math.round((n - anos) * 100);
    let txtAnos = anos > 0 ? `${anos} ${anos === 1 ? 'ano' : 'anos'}` : "";
    let txtMeses = meses > 0 ? `${meses} ${meses === 1 ? 'm√™s' : 'meses'}` : "";
    if (txtAnos && txtMeses) return `${txtAnos} e ${txtMeses}`;
    return txtAnos || txtMeses || "0 meses";
}

async function loadFromCloud() {
    const statusEl = document.getElementById("syncStatus");
    statusEl.innerText = "üîÑ Sincronizando dados...";
    try {
        const { data, error } = await sb.from("painel_dados").select("*").eq("id", 1).maybeSingle();
        if (error) throw error;
        if (data && data.dados) {
            state = data.dados;
            statusEl.innerText = "‚úÖ Atualizado: " + new Date(data.updated_at).toLocaleTimeString();
        } else {
            statusEl.innerText = "üå∏ Sem dados na nuvem.";
        }
        render();
    } catch (e) {
        statusEl.innerText = "‚ùå Erro ao carregar.";
    }
}

async function saveData() {
    const statusEl = document.getElementById("syncStatus");
    const btn = document.getElementById("btnSalvar");
    statusEl.innerText = "‚è≥ Enviando...";
    btn.disabled = true;

    try {
        const { error } = await sb.from("painel_dados").upsert({
            id: 1,
            dados: state,
            updated_at: new Date().toISOString()
        });
        if (error) throw error;
        statusEl.innerText = "‚úÖ Salvo com sucesso!";
        alert("‚ú® Dados sincronizados!");
    } catch (e) {
        statusEl.innerText = "‚ùå Erro ao salvar.";
    } finally {
        btn.disabled = false;
    }
}

async function updateStatus(index, newStatus) {
    const item = state[state.active][index];
    const oldStatus = item.status;
    item.status = newStatus;
    try {
        await sb.from("painel_logs").insert([{
            paciente: item.name,
            status_anterior: oldStatus,
            status_novo: newStatus,
            aba: state.active
        }]);
    } catch(e) {}
    render();
}

function render(){
    const body = document.getElementById("tableBody");
    const list = state[state.active] || [];
    document.getElementById("dateLabel").innerText = state.active === "proximo" ? "Deve retornar em" : "Venceu em";
    body.innerHTML = "";

    const all = [...(state.proximo || []), ...(state.vencidos || [])];
    document.getElementById("cPend").textContent = all.filter(i => i.status === "Pendente").length;
    document.getElementById("cAgen").textContent = all.filter(i => i.status === "Agendado").length;
    document.getElementById("cTent").textContent = all.filter(i => i.status === "Tentar Novamente").length;
    document.getElementById("cRec").textContent = all.filter(i => i.status === "Recusou").length;

    list.forEach((it, i) => {
        const waClean = it.tel ? it.tel.replace(/\D/g,"") : "";
        
        // MENSAGENS CARINHOSAS E REVISADAS
        let msg = "";
        if(state.active === "proximo") {
            msg = "Oi! Aqui √© a Raquel, secret√°ria da Dra. Rafaela Loiola. Tudo bem? Passando para avisar que a consulta do(a) *" + it.name + "* est√° prevista para *" + it.due + "*. Vamos agendar um hor√°rio para o acompanhamento?";
        } else {
            msg = "Oi! Aqui √© a Raquel, secret√°ria da Dra. Rafaela Loiola. Como voc√™s est√£o? Notei que a consulta do(a) *" + it.name + "* venceu em *" + it.due + "*. Vamos aproveitar para deixar a sa√∫de do pequeno em dia e agendar o retorno?";
        }
        
        const waUrl = "https://wa.me/55" + waClean + "?text=" + encodeURIComponent(msg);

        const tr = document.createElement("tr");
        tr.className = `status-${it.status.replace(/\s/g, '\\ ')}`;
        tr.innerHTML = `
            <td>${i+1}</td>
            <td style="text-align:left"><strong>${it.name}</strong></td>
            <td>
                <a class="wa-btn" target="_blank" href="${waUrl}">
                    WhatsApp
                </a>
                <div style="font-size:10px; margin-top:4px">${it.tel}</div>
            </td>
            <td>${it.last}</td>
            <td>${formatAge(it.age)}</td>
            <td>${it.due}</td>
            <td>
                <select onchange="updateStatus(${i}, this.value)">
                    <option ${it.status==="Pendente"?"selected":""}>Pendente</option>
                    <option ${it.status==="Agendado"?"selected":""}>Agendado</option>
                    <option ${it.status==="Tentar Novamente"?"selected":""}>Tentar Novamente</option>
                    <option ${it.status==="Recusou"?"selected":""}>Recusou</option>
                </select>
            </td>
            <td><textarea onchange="state['${state.active}'][${i}].obs=this.value">${it.obs||""}</textarea></td>
        `;
        body.appendChild(tr);
    });
}

function changeTab(t){
    state.active = t;
    document.getElementById("tP").classList.toggle("active", t === "proximo");
    document.getElementById("tV").classList.toggle("active", t === "vencidos");
    render();
}

function importCSV(type, input){
    if(prompt("Senha de Importa√ß√£o") !== "u47hbyk4"){ alert("Senha incorreta!"); return; }
    const file = input.files[0];
    if(!file) return;
    file.text().then(txt => {
        state[type] = []; 
        const rows = txt.split(/\r?\n/).slice(1);
        state[type] = rows.map(r => {
            const c = r.split(";").map(x => x.trim());
            if(c.length < 2) return null;
            return { name: c[0], tel: c[1], last: c[2]||"", age: c[3]||"", due: c[4]||"", status: "Pendente", obs: "" };
        }).filter(x => x && x.name);
        render();
        alert("Lista importada com sucesso!");
    });
}

async function gerarLog(){
    if(!logIni.value || !logFim.value) { alert("Escolha as datas"); return; }
    const {data, error} = await sb.from("painel_logs")
        .select("*")
        .gte("data_hora", logIni.value+"T00:00:00")
        .lte("data_hora", logFim.value+"T23:59:59");
    if(error || !data || data.length === 0) { alert("Nenhum log."); return; }
    let txt = "LOG DE ATIVIDADES\n\n";
    data.forEach(l => {
        txt += `${new Date(l.data_hora).toLocaleString()} | ${l.paciente} | ${l.status_anterior} -> ${l.status_novo}\n`;
    });
    const blob = new Blob([txt], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `log_rafaela.txt`;
    a.click();
}

document.addEventListener("DOMContentLoaded", loadFromCloud);
</script>

</body>
</html>
