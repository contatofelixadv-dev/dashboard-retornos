<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Retornos | Dra. Rafaela Loiola</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d48e9b;
            --accent: #9c5d6a;
            --bg: #fdf8f9;
            --text: #4a3a3d;
            --border: #eecad0;
            --wa-green: #25d366;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }

        header {
            background: linear-gradient(135deg, #e4aab5 0%, #d48e9b 100%);
            color: white; padding: 1.5rem 1rem; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 { font-family: 'Quicksand', sans-serif; margin: 0; font-size: 1.8rem; letter-spacing: 1px; }
        header p { margin: 5px 0 0; font-size: 1rem; opacity: 0.9; font-weight: 600; }

        .container { max-width: 98%; margin: 1rem auto; }

        .import-section {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 1.5rem;
        }
        .import-box {
            background: white; padding: 10px 15px; border-radius: 15px;
            border: 2px dashed var(--primary); text-align: center; flex: 1; max-width: 350px;
        }
        .import-box span { display: block; font-size: 0.75rem; font-weight: 700; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; }
        
        .btn-file {
            background: var(--accent); color: white; border: none; padding: 8px 12px;
            border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.8rem; width: 100%; transition: 0.3s;
        }
        .btn-file:hover { background: var(--primary); }

        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 1rem; }
        .tab-btn {
            padding: 12px 30px; border-radius: 25px; border: 1px solid var(--border);
            background: white; color: var(--accent); font-weight: 700; cursor: pointer;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(212, 142, 155, 0.3); }

        .table-card { background: white; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #f9ebed; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        th {
            background: #fcf0f2; padding: 15px 5px; color: var(--accent);
            font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--border);
        }

        .w-seq { width: 45px; }
        .w-paciente { width: 22%; }
        .w-tel { width: 220px; }
        .w-data { width: 100px; }
        .w-idade { width: 160px; }
        .w-status { width: 150px; }
        .w-obs { width: auto; }

        td { padding: 12px 5px; text-align: center; border-bottom: 1px solid #f9ebed; font-size: 0.88rem; vertical-align: middle; }

        .wa-btn {
            display: inline-flex; align-items: center; gap: 8px;
            background: #e9f7ef; color: #1e8449; text-decoration: none;
            padding: 8px 15px; border-radius: 12px; font-weight: 700; border: 1px solid #d4efdf;
            transition: 0.3s;
        }
        .wa-btn:hover { background: var(--wa-green); color: white; }

        textarea { width: 95%; height: 45px; border-radius: 10px; border: 1px solid var(--border); padding: 8px; font-family: inherit; resize: vertical; }
        select { padding: 8px; border-radius: 10px; border: 1px solid var(--border); width: 95%; cursor: pointer; }

        .btn-save {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--accent); color: white; border: none;
            padding: 15px 35px; border-radius: 50px; font-weight: 700; cursor: pointer; 
            box-shadow: 0 8px 20px rgba(156, 93, 106, 0.3); display: flex; align-items: center; gap: 10px;
        }

        .footer-spacer { height: 150px; width: 100%; }
    </style>

<script>
(function(){
    const PAGE_PASSWORD = "rafaloiola2026";
    const entered = prompt("Digite a senha para acessar o painel:");
    if (entered !== PAGE_PASSWORD) {
        alert("Senha incorreta.");
        document.body.innerHTML = "";
        throw new Error("Unauthorized");
    }
})();
</script>

</head>
<body>

<header>
    <h1>Controle de Retornos de Pacientes</h1>
    <p>üå∏ Dra. Rafaela Loiola üå∏</p>
</header>

<div class="container">
    <div class="import-section">
        <div class="import-box">
            <span>‚ú® Lista: Pr√≥ximo M√™s ‚ú®</span>
            <input type="file" id="fP" hidden onchange="importCSV('proximo', this)">
            <button class="btn-file" onclick="document.getElementById('fP').click()">üìÇ CARREGAR A VENCER</button>
        </div>
        <div class="import-box">
            <span>‚≠ê Lista: Vencidos ‚≠ê</span>
            <input type="file" id="fV" hidden onchange="importCSV('vencidos', this)">
            <button class="btn-file" onclick="document.getElementById('fV').click()">üìÇ CARREGAR VENCIDOS</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" id="tP" onclick="changeTab('proximo')">üçº A VENCER</button>
        <button class="tab-btn" id="tV" onclick="changeTab('vencidos')">‚ö†Ô∏è VENCIDOS</button>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th class="w-seq">#</th>
                    <th class="w-paciente">Paciente</th>
                    <th class="w-tel">WHATSAPP</th>
                    <th class="w-data">√öltima Consulta</th>
                    <th class="w-idade">Idade na Consulta</th>
                    <th class="w-data" id="dateLabel">Vencimento</th>
                    <th class="w-status">Status</th>
                    <th class="w-obs">Observa√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="footer-spacer"></div>

<button class="btn-save" onclick="saveData()">
    <span>üß∏</span> SALVAR ALTERA√á√ïES
</button>

<script>
    // CHAVE √öNICA PARA N√ÉO PERDER DADOS
    const STORAGE_KEY = 'DraRafaela_Dados_Oficial';

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        active: 'proximo',
        proximo: [],
        vencidos: []
    };

    function formatAge(ageStr) {
        if (!ageStr) return "";
        let cleanAge = ageStr.replace(',', '.');
        let num = parseFloat(cleanAge);
        if (isNaN(num)) return ageStr;
        let anos = Math.floor(num);
        let meses = Math.round((num - anos) * 100);
        let tAnos = anos === 1 ? "1 ano" : anos + " anos";
        let tMeses = meses === 1 ? "1 m√™s" : meses + " meses";
        if (anos > 0 && meses > 0) return `${tAnos} e ${tMeses}`;
        return anos > 0 ? tAnos : tMeses;
    }

    function changeTab(t) {
        state.active = t;
        document.getElementById('tP').classList.toggle('active', t === 'proximo');
        document.getElementById('tV').classList.toggle('active', t === 'vencidos');
        render();
    }

    async function importCSV(type, input) {
        const IMPORT_PASSWORD = "u47hbyk4";
        const entered = prompt("Digite a senha para importar CSV:");
        if (entered !== IMPORT_PASSWORD) {
            alert("Senha incorreta para importa√ß√£o.");
            input.value = '';
            return;
        }
        const file = input.files[0];
        if (!file) return;
        const text = await file.text();
        const rows = text.split(/\r?\n/).filter(line => line.trim() !== "" && line.includes(';'));
        
        state[type] = rows.slice(1).map(line => {
            const c = line.split(';').map(cell => cell.trim());
            return { 
                name: c[0] || "", tel: c[1] || "", last: c[2] || "", 
                age: formatAge(c[3] || ""), due: c[4] || "", 
                status: 'Pendente', obs: '' 
            };
        }).filter(item => item.name !== "");

        autoSave();
        render();
        alert('Lista carregada com carinho! ‚ú®üçº');
        input.value = '';
    }

    function render() {
        const body = document.getElementById('tableBody');
        const list = state[state.active];
        document.getElementById('dateLabel').innerText = state.active === 'proximo' ? "DEVE VIR EM" : "VENCEU EM";

        body.innerHTML = '';
        if (list.length === 0) {
            body.innerHTML = '<tr><td colspan="8" style="padding:60px; color:#aaa;">Aguardando sua lista, Doutora! ‚ú®</td></tr>';
            return;
        }

        list.forEach((item, i) => {
            const wa = `https://wa.me/55${item.tel.replace(/\D/g,'')}`;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color:#eecad0; font-weight:bold;">${i+1}</td>
                <td style="text-align:left; font-weight:700; color:var(--accent)">${item.name}</td>
                <td>
                    <a href="${wa}" target="_blank" class="wa-btn">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                        </svg>
                        ${item.tel}
                    </a>
                </td>
                <td>${item.last}</td>
                <td style="color:#888;">${item.age}</td>
                <td style="font-weight:700; color:var(--accent)">${item.due}</td>
                <td>
                    <select onchange="updateRow(${i}, 'status', this.value)">
                        <option value="Pendente" ${item.status==='Pendente'?'selected':''}>‚è≥ Aguardando</option>
                        <option value="Agendado" ${item.status==='Agendado'?'selected':''}>‚úÖ Agendado</option>
                        <option value="Tentar Novamente" ${item.status==='Tentar Novamente'?'selected':''}>üîÅ Tentar Novamente</option>
                        <option value="Recusou" ${item.status==='Recusou'?'selected':''}>‚ùå Recusou</option>
                    </select>
                </td>
                <td><textarea onchange="updateRow(${i}, 'obs', this.value)">${item.obs || ''}</textarea></td>
            `;
            body.appendChild(tr);
        });
    }

    function updateRow(idx, field, val) {
        state[state.active][idx][field] = val;
        autoSave();
    }

    function autoSave() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function saveData() {
        autoSave();
        alert('Dados guardados com sucesso, Doutora! üíñüß∏');
    }

    render();
</script>
</body>
</html>