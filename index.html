<!DOCTYPE html>
<html lang="pt-br">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Retornos | Dra. Rafaela Loiola</title>

<!-- ===== PROTEÃ‡ÃƒO POR SENHA (ÃšNICA E DEFINITIVA) ===== -->
<style>
html { display: none !important; }
</style>

<script>
(function () {
    const PAGE_PASSWORD = "rafaloiola2026";
    const entered = prompt("Digite a senha para acessar o painel:");
    if (entered !== PAGE_PASSWORD) {
        alert("Senha incorreta. Acesso bloqueado.");
        document.open(); document.write(""); document.close();
        return;
    }
    document.documentElement.style.display = "block";
})();
</script>

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- ===== SUPABASE ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
    "https://kavfloijxglfzlwgvtmd.supabase.co",
    "sb_publishable_Fqmz6y2CXCzBCzGLINr2Pg_L_my3zDP"
);
</script>

<style>
body {
    font-family: 'Inter', sans-serif;
    background: #fdf8f9;
    color: #4a3a3d;
    margin: 0;
}

:root {
    --primary: #d48e9b;
    --accent: #9c5d6a;
    --border: #eecad0;
}

header {
    background: linear-gradient(135deg,#e4aab5,#d48e9b);
    color: #fff;
    padding: 1.5rem;
    text-align: center;
}

.container { max-width: 98%; margin: 1rem auto; }

.import-section {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 1.5rem;
}

.import-box {
    background: #fff;
    padding: 10px 15px;
    border-radius: 15px;
    border: 2px dashed var(--primary);
    text-align: center;
    flex: 1;
    max-width: 350px;
}

.btn-file {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
}

.tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 1rem;
}

.tab-btn {
    padding: 12px 30px;
    border-radius: 25px;
    border: 1px solid var(--border);
    background: #fff;
    font-weight: 700;
    cursor: pointer;
}

.tab-btn.active {
    background: var(--primary);
    color: #fff;
}

.table-card {
    background: #fff;
    border-radius: 20px;
    overflow: hidden;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #fcf0f2;
    padding: 12px;
    font-size: 0.75rem;
}

td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #f1dfe3;
}

select, textarea {
    width: 95%;
    border-radius: 8px;
    padding: 6px;
    border: 1px solid var(--border);
}

.btn-save {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 15px 30px;
    border-radius: 40px;
    font-weight: 700;
    cursor: pointer;
}

.log-box {
    margin: 40px auto;
    background: #fff;
    padding: 20px;
    border-radius: 20px;
    max-width: 600px;
    text-align: center;
}

.log-box input {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.footer-spacer { height: 120px; }
</style>
</head>

<body>

<header>
<h1>Controle de Retornos de Pacientes</h1>
<p>Dra. Rafaela Loiola</p>
</header>

<div class="container">

<div class="import-section">
    <div class="import-box">
        <input type="file" id="fP" hidden onchange="importCSV('proximo',this)">
        <button class="btn-file" onclick="fP.click()">ðŸ“‚ Importar PrÃ³ximo MÃªs</button>
    </div>
    <div class="import-box">
        <input type="file" id="fV" hidden onchange="importCSV('vencidos',this)">
        <button class="btn-file" onclick="fV.click()">ðŸ“‚ Importar Vencidos</button>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" id="tP" onclick="changeTab('proximo')">A Vencer</button>
    <button class="tab-btn" id="tV" onclick="changeTab('vencidos')">Vencidos</button>
</div>

<div class="table-card">
<table>
<thead>
<tr>
<th>#</th><th>Paciente</th><th>Status</th><th>ObservaÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<div class="log-box">
<h3>Gerar LOG (.txt)</h3>
<input type="date" id="logIni">
<input type="date" id="logFim">
<br><br>
<button class="btn-file" onclick="gerarLog()">GERAR ARQUIVO</button>
</div>

<div class="footer-spacer"></div>

<button class="btn-save" onclick="saveData()">Salvar</button>

<script>
const STORAGE_KEY="DraRafaela_Dados_Oficial";

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    active:"proximo", proximo:[], vencidos:[]
};

function changeTab(t){
    state.active=t;
    tP.classList.toggle("active",t==="proximo");
    tV.classList.toggle("active",t==="vencidos");
    render();
}

function importCSV(type,input){
    if(prompt("Senha CSV")!=="u47hbyk4"){input.value="";return;}
    input.files[0].text().then(txt=>{
        const rows=txt.split(/\r?\n/).slice(1);
        state[type]=rows.map(r=>{
            const c=r.split(";");
            return {name:c[0]||"",status:"Pendente",obs:""};
        }).filter(x=>x.name);
        autoSave(); render();
    });
}

async function update(i,v){
    const item=state[state.active][i];
    const old=item.status;
    if(old===v)return;
    item.status=v;

    await supabase.from("painel_logs").insert({
        paciente:item.name,
        status_anterior:old,
        status_novo:v,
        aba:state.active
    });

    autoSave();
}

function render(){
    const body=document.getElementById("tableBody");
    body.innerHTML="";
    const list=state[state.active];
    if(!list.length){
        body.innerHTML="<tr><td colspan='4'>Sem dados</td></tr>";return;
    }
    list.forEach((it,i)=>{
        body.innerHTML+=`
        <tr>
        <td>${i+1}</td>
        <td>${it.name}</td>
        <td>
        <select onchange="update(${i},this.value)">
        <option ${it.status==="Pendente"?"selected":""}>Pendente</option>
        <option ${it.stat
